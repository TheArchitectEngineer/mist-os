# fuchsia_idk_repository() validation data

This directory contains data that is used to validate the script
at `//build/bazel/fuchsia_idk/generate_repository.py`, which
parses an input IDK that follows the official IDK layout and
creates a new output IDK directory with atom metadata files that
use Bazel target labels, instead of relative file paths, to
reference Ninja-generated artifacts.

For example, for `sdk://pkg/fdio/meta.json` the original metadata
file looks like:

```
{
  "binaries": {
    "x64": {
      "debug": ".build-id/87/e97ba9fa4548c0060e2cb43b2537a87c62fae4.debug",
      "dist": "arch/x64/dist/libfdio.so",
      "dist_path": "lib/libfdio.so",
      "link": "arch/x64/lib/libfdio.so"
    }
  },
  ...
}
```

But the one found in the output IDK will contain:

```
{
  "binaries": {
    "x64": {
      "debug": "@fuchsia_idk//arch/x64:debug/libfdio.so",
      "dist": "@fuchsia_idk//arch/x64:dist/libfdio.so",
      "dist_path": "lib/libfdio.so",
      "link": "@fuchsia_idk//arch/x64:lib/libfdio.so"
    }
  },
  ...
}
```

Which contain labels referencing targets that will be defined
in `${output_base}/arch/x64/BUILD.bazel`, a file that will be
mapped in the Bazel workspace later as
`@fuchsia_sdk//arch/x64:BUILD.bazel`.

# Directory layout

This directory contains the following sub-directories:

- `input_idk`: A fixed and minimal input IDK directory, that
  follows the official IDK layout. This means a `meta/manifest.json`
  file that references one or more metadata manifest JSON files
  located elsewhere in the directory.

  Apart from these metadata files, all other files should be
  symlinks to files that exist in the top-level `source_files`
  or `ninja_artifacts` directories, using relative target paths.

- `source_files`: A directory that contains files that are treated as
  source files by the processing script.

- `ninja_artifacts`: A directory that contains files that are treated as
  Ninja build directory, i.e. one that contains Ninja-generated artifacts,
  by the processing script.

- `expected_idk`: A directory containing the expected (golden) output IDK
  that the processing script is supposed to generate when parsing the
  content of `input_idk`, `src` and `out`.

As a special case, FIDL files use a `"_fidl"` file suffix, instead of `".fidl"`,
in order to avoid trigerring API-Review requirements on Gerrit, which would
be futile since these are not real files.

Similarly, the `"_zip"` suffix is used instead of `".zip"` for a fake Zip
archive used for the documentation atom.

# Usage

The `//build/bazel/fuchsia_idk:integration_test` target can be built to
run, at build time, the validation script, which invokes
`generate_repository.py` to generate a new output IDK, and compare its
results with the content of `expected_idk`.

For debugging, it is possible to invoke the script manually to see the
output IDK generated by the script in full details, by doing:

```
python3 build/bazel/fuchsia_idk/generate_repository_validation.py \
  --build-dir /tmp/idk_validation
```

Then look at the content of `/tmp/idk_validation/output_idk`, which
can be compared manually with that of `/tmp/idk_validation/expected_idk`.
